# Правила разработки (для ИИ-ассистента)

Источник принципов: см. @vision.md. Не дублируем — ниже только практические правила, влияющие на качество кода.

## Утилиты и инструменты
- **Python 3.11+**: целевая версия интерпретатора (см. @vision.md).
- **aiogram** для Telegram-бота, **openai** клиент для OpenRouter, **pytest** для тестов, **uv** для зависимостей, **Docker** для контейнеров, **Make** для задач — детали в @vision.md.
- Все новые задачи оформляй командами в `Makefile` (build/test/run), не плодить скрипты.

## Основные принципы разработки
- Придерживайся KISS, итеративности, модульности и SRP как описано в @vision.md.
- Отдавай приоритет читаемости и простоте над «магией». Минимум скрытой логики.
- Малые PR: один фокус — одна правка. Ясные сообщения коммитов.
- YAGNI: Реализуй только то, что нужно сейчас; не добавляй функциональность «на будущее».
- Single Responsibility (SRP): Каждый модуль/класс/функция должна иметь одну чёткую ответственность и одну причину для изменения.

## Стиль кода
- Следуй PEP 8/PEP 257. Именование: полные, говорящие имена; без аббревиатур.
- Предпочитай функции классам; не вводи классы, если можно обойтись функциями.
- Простые `try/except` без сложной многоступенчатой обработки; исключения не глушить.
- Прямолинейная логика: избегай глубокой вложенности (не более 1–2 уровней), используй ранние возвраты.
- Пиши функции с явными входами/выходами. Не использовать глобальное состояние.
- Типизация `typing` обязательна для публичных функций и API.

 

## Работа с зависимостями
- Используй изолированное виртуальное окружение `.venv` в корне проекта для установки зависимостей (не ставить глобально).
- Управление — через **uv**. Фиксируй версии, избегай «latest».
- Разделяй обязательные и dev-зависимости. Не добавляй лишнего.
- Перед добавлением библиотеки — проверяй, нет ли стандартного решения.

## Обработка ошибок
- Принцип fail-fast (см. @vision.md). Явно обрабатывай ожидаемые ошибки; не глуши исключения.
- Логируй ошибки и ключевые события через стандартный `logging` с форматами из @vision.md.
- Пользовательские сообщения об ошибках в боте — короткие, понятные, без внутренних деталей.

## Конфигурация
- Только через переменные окружения из `.env`; шаблон — `.env.example` (см. @vision.md).
- Валидация обязательных переменных при старте; значения по умолчанию — только для необязательных.
- Не хардкодить секреты. Доступ к конфигу — через `src/config.py`.
 - Никаких config-файлов, YAML, JSON.
 - `os.getenv()` без дефолтных значений.
 - Не использовать `pydantic-settings`, `dynaconf` и подобные менеджеры конфигурации.

## Данные
- Простые структуры в памяти: `dict[chat_id] = [messages]`
- Никаких ORM, баз данных, схем валидации
- История диалогов как список словарей (формат в @vision.md)

## Логирование
- Один файл `logs/bot.log`
- Простой `logging.basicConfig()` 
- Только уровни INFO и ERROR
- Формат логов по примеру из @vision.md

## Запрещено

- Async/await (кроме aiogram handlers)
- Классы для простых функций
- Сложные паттерны (Factory, Builder, etc.)
- Middleware и декораторы
- Валидация входных данных
- Retry механизмы
- Конфигурационные файлы
- БД и ORM

## Тестирование
- Пиши `pytest`-тесты на новую функциональность. Покрывай happy-path и ключевые негативные случаи.
- Юнит-тесты для чистых функций, интеграционные — для взаимодействий бота и LLM-клиента.
- Тесты должны быть детерминированными; изоляция внешних сервисов — моками/фейками.
