# Архитектура системы

## Обзор

Telegram-бот консультант построен по принципу **KISS** (Keep It Simple Stupid) с модульной архитектурой. Система состоит из четырех основных компонентов, взаимодействующих через четко определенные интерфейсы.

## Диаграмма компонентов

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram      │    │   Bot Handler   │    │   LLM Client    │
│   User          │◄──►│   (aiogram)     │◄──►│   (OpenRouter)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   Config        │
                       │   (.env)        │
                       └─────────────────┘
```

## Принципы архитектуры

### 1. **Модульность**
- Каждый компонент имеет единственную ответственность
- Четкое разделение между обработкой сообщений, LLM-интеграцией и конфигурацией
- Независимые модули, которые можно тестировать отдельно

### 2. **Stateless Design**
- Бот не хранит состояние между перезапусками
- История диалогов хранится в памяти процесса
- Простота масштабирования и отказоустойчивости

### 3. **Конфигурация через переменные окружения**
- Все настройки в `.env` файле
- Никаких хардкодированных значений
- Легкая настройка для разных окружений

### 4. **Fail-Fast**
- Быстрое обнаружение ошибок при запуске
- Валидация конфигурации на старте
- Явная обработка ошибок без их подавления

## Поток данных

### 1. **Входящее сообщение**
```
Telegram User → Telegram API → Bot Handler → Message Processing
```

### 2. **Обработка через LLM**
```
Message → History Context → LLM Client → OpenRouter API → Response
```

### 3. **Ответ пользователю**
```
LLM Response → Bot Handler → Telegram API → Telegram User
```

## Технологический стек

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| **Bot Framework** | aiogram 3.x | Обработка Telegram API |
| **LLM Integration** | OpenAI Client | Работа с OpenRouter API |
| **Configuration** | python-dotenv | Управление настройками |
| **Logging** | Python logging | Логирование событий |
| **Containerization** | Docker | Развертывание |
| **Automation** | Make | Автоматизация задач |

## Ключевые файлы

### Основные модули
- `src/bot.py` — точка входа и инициализация
- `src/handlers.py` — обработчики сообщений Telegram
- `src/llm_client.py` — клиент для работы с LLM
- `src/config.py` — управление конфигурацией

### Конфигурация
- `.env` — переменные окружения (не в git)
- `env.example` — шаблон конфигурации
- `docs/system_prompt.md` — системный промт для LLM

### Инфраструктура
- `Dockerfile` — образ приложения
- `docker-compose.yml` — оркестрация контейнеров
- `Makefile` — команды автоматизации

## Модель данных

### История диалогов
```python
{
    "chat_id": int,
    "messages": [
        {
            "role": "system|user|assistant",
            "content": "текст сообщения",
            "timestamp": datetime
        }
    ]
}
```

### Конфигурация
```python
{
    "TELEGRAM_BOT_TOKEN": str,
    "OPENROUTER_API_KEY": str,
    "LLM_MODEL_NAME": str,
    "LLM_TEMPERATURE": float,
    "LLM_MAX_TOKENS": int,
    "HISTORY_MAX_TURNS": int,
    "LOG_LEVEL": str,
    "LOG_FILE": str
}
```

## Обработка ошибок

### Уровни обработки
1. **Конфигурация** — валидация при запуске
2. **Сеть** — таймауты и retry для API
3. **LLM** — обработка ошибок OpenRouter
4. **Telegram** — обработка ошибок Bot API
5. **Пользователь** — понятные сообщения об ошибках

### Логирование
- Все ошибки записываются в `logs/bot.log`
- Разные уровни: INFO, ERROR
- Контекстная информация для отладки

## Масштабирование

### Текущие ограничения
- Один процесс на один экземпляр бота
- История диалогов в памяти (теряется при перезапуске)
- Синхронная обработка сообщений

### Возможности расширения
- Webhook вместо polling для высокой нагрузки
- Внешнее хранилище для истории диалогов
- Асинхронная обработка сообщений
- Горизонтальное масштабирование через load balancer

## Безопасность

### Токены и ключи
- Все секреты в переменных окружения
- `.env` файл исключен из git
- Валидация токенов при запуске

### API безопасность
- Таймауты для внешних запросов
- Обработка rate limits
- Валидация входящих данных

## Мониторинг

### Логирование
- Все взаимодействия с пользователями
- Запросы и ответы LLM
- Ошибки и исключения
- Метрики производительности

### Health checks
- Docker health check для контейнера
- Проверка доступности внешних API
- Мониторинг использования ресурсов

---

**Следующий шаг:** [Детальное описание компонентов](components.md)
