
# Техническое видение проекта

## 1. Технологии

**Backend:**
- **Python 3.11+** - основной язык разработки
- **aiogram** - библиотека для работы с Telegram Bot API
- **openai** - клиент для работы с OpenRouter API
- **pytest** - тестирование
- **uv** - управление зависимостями

**Инфраструктура:**
- **Docker** - контейнеризация
- **Make** - автоматизация задач

**Логирование:**
- **Python logging** - простое логирование в файлы

## 2. Принципы разработки

1. **KISS (Keep It Simple Stupid)** - максимальная простота решения
2. **Итеративный подход** - начинаем с MVP и постепенно добавляем функциональность
3. **Чистый код** - понятные имена, комментарии, документация
4. **Быстрые итерации** - возможность быстро вносить изменения и тестировать
5. **Модульность** - разделение кода на логические компоненты
6. **Единственная ответственность** - каждый модуль решает одну задачу
7. **Конфигурация через переменные окружения** - все настройки в .env
8. **Fail-fast** - быстрое обнаружение ошибок
9. **Stateless** - бот не хранит состояние между перезапусками

## 3. Структура проекта

```
llmstart_project1-1/
├── src/
│   ├── bot/
│   │   ├── __init__.py
│   │   └── handlers.py        # Обработчики сообщений
│   ├── llm/
│   │   ├── __init__.py
│   │   └── client.py         # Клиент для OpenRouter
│   ├── config.py             # Настройки приложения
│   └── main.py              # Точка входа
├── tests/
│   └── test_bot.py          # Базовые тесты бота (pytest)
├── docs/
│   ├── product_idea.md
│   └── vision.md
├── .venv/                   # Локальное виртуальное окружение
├── .env.example
├── .gitignore
├── Dockerfile
├── Makefile
├── pyproject.toml
└── README.md
```

## 4. Архитектура проекта

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram      │    │   Bot Handler   │    │   LLM Client    │
│   User          │◄──►│   (aiogram)     │◄──►│   (OpenRouter)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   Config        │
                       │   (.env)        │
                       └─────────────────┘
```

**Компоненты:**
- **Bot Handler** - обработка сообщений от пользователей
- **LLM Client** - взаимодействие с OpenRouter API
- **Config** - управление настройками через переменные окружения

**Обработка ошибок:**
- Использование try/catch для обработки исключений
- Уведомление пользователей об ошибках через Telegram

## 5. Модель данных

**Структуры данных в памяти:**
- **Диалог с пользователем** - список сообщений в формате:
  ```python
  {
      "user_id": int,
      "messages": [
          {"role": "system", "content": "системное сообщение", "timestamp": datetime},
          {"role": "user", "content": "текст сообщения", "timestamp": datetime},
          {"role": "assistant", "content": "ответ бота", "timestamp": datetime}
      ]
  }
  ```

**Конфигурация (переменные окружения):**
- `TELEGRAM_BOT_TOKEN` - токен бота
- `OPENROUTER_API_KEY` - ключ для OpenRouter
- `OPENROUTER_API_URL` - URL для OpenRouter API (по умолчанию https://openrouter.ai/api/v1)
- `LLM_MODEL_NAME` - название модели LLM (например, openai/gpt-3.5-turbo)
- `LLM_TEMPERATURE` - температура для генерации (по умолчанию 0.7)
- `LLM_MAX_TOKENS` - максимальное количество токенов в ответе (по умолчанию 500)
- `SYSTEM_PROMPT` - системный промпт с информацией о компании
- `MAX_CONTEXT_TOKENS` - максимальный размер контекста (по умолчанию 2000)
- `LOG_LEVEL` - уровень логирования

## 6. Работа с LLM

**Интеграция с OpenRouter:**
- Использование OpenAI клиента для работы с OpenRouter API
- Передача истории диалога в формате messages
- Обработка ошибок API (rate limits, недоступность сервиса)

**Промпт-инжиниринг:**
- Системный промпт с информацией о компании и услугах
- Контекст диалога для поддержания разговора
- Обработка различных типов запросов клиентов

**Настройки LLM:**
- Максимальный размер контекста: 2k токенов (настраивается через переменную окружения `MAX_CONTEXT_TOKENS`)
- Прямые ответы согласно указаниям из промпта
- Логирование запросов и ответов LLM для отладки

**Обработка команд:**
- `/start` - приветствие и описание возможностей бота
- `/help` - справка по использованию бота

## 7. Мониторинг

**Логирование:**
- Простое файловое логирование без ротации по времени
- Разные уровни логирования (DEBUG, INFO, WARNING, ERROR)
- Логирование всех взаимодействий с пользователями
- Логирование запросов и ответов LLM

**Обработка ошибок:**
- Уведомления пользователей об ошибках через Telegram
- Логирование всех ошибок в файлы

## 8. Сценарии работы

**Сценарий 1: Первое знакомство**
1. Пользователь отправляет `/start`
2. Бот приветствует и объясняет свои возможности
3. Пользователь задает вопрос о услугах компании
4. Бот анализирует запрос и дает релевантный ответ

**Сценарий 2: Консультация**
1. Пользователь описывает свою проблему
2. Бот задает уточняющие вопросы
3. Бот предлагает подходящие услуги компании
4. При необходимости направляет к специалисту

**Сценарий 3: Обработка ошибок**
1. Возникает ошибка (API недоступен, превышен лимит токенов)
2. Бот уведомляет пользователя об ошибке
3. Ошибка логируется в файл

**Сценарий 4: Обработка входящих сообщений**
1. Пользователь отправляет сообщение
2. Бот проверяет тип сообщения (только текстовые)
3. Нетекстовые данные игнорируются
4. Текстовые сообщения обрабатываются согласно промпту

## 9. Деплой

**Контейнеризация:**
- Dockerfile для создания образа приложения
- Использование Python 3.11 slim образа
- Копирование кода и установка зависимостей

**Переменные окружения:**
- Все настройки через .env файл
- .env.example как шаблон для настройки

**Makefile:**
- Команды для сборки, запуска и тестирования
- Упрощение процесса разработки

**Локальное развертывание:**
- Развертывание на локальной машине
- Запуск через Docker контейнер
- Простая настройка через .env файл

## 10. Подход к конфигурированию

**Конфигурация через переменные окружения:**
- Все настройки в .env файле
- .env.example как шаблон с примерами значений
- Валидация обязательных переменных при запуске

**Структура конфигурации:**
- `config.py` - загрузка и валидация настроек
- Использование библиотеки `python-dotenv` для работы с .env
- Значения по умолчанию для необязательных параметров
- Валидация типов данных для переменных окружения

## 11. Подход к логгированию

**Структура логирования:**
- Использование стандартной библиотеки `logging`
- Разные уровни: DEBUG, INFO, WARNING, ERROR
- Логирование в один файл с настраиваемым форматом

**Что логировать:**
- Все входящие сообщения от пользователей
- Запросы и ответы LLM
- Ошибки и исключения
- Запуск и остановка приложения

**Формат логов:**
- Временная метка в формате ISO 8601
- Уровень логирования
- Модуль/функция
- Сообщение

**Пример формата:**
```
2024-01-15T10:30:45.123Z INFO bot.handlers:message_handler - Получено сообщение от пользователя 12345
```
